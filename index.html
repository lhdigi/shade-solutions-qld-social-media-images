<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shade Solutions QLD - Image Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-storage-compat.js"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCjT-UjngKoElF2RH1BayCup7CzjIrABBc",
      authDomain: "shade-solutions-tracker.firebaseapp.com",
      projectId: "shade-solutions-tracker",
      storageBucket: "shade-solutions-tracker.firebasestorage.app",
      messagingSenderId: "347513530369",
      appId: "1:347513530369:web:93abc25b52819139f2b800"
    };

    // Initialise Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    function ShadeTracker() {
      const [images, setImages] = useState([]);
      const [file, setFile] = useState(null);
      const [folderName, setFolderName] = useState("");
      const [sharepointDate, setSharepointDate] = useState("");
      const [uploading, setUploading] = useState(false);
      const [uploadProgress, setUploadProgress] = useState(0);

      // Load images
      useEffect(() => {
        const unsub = db.collection("images").orderBy("addedDate", "desc").onSnapshot(snap => {
          setImages(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        });
        return () => unsub();
      }, []);

      const compressImage = (file) => new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const MAX = 1920;
            let { width, height } = img;
            if (width > height && width > MAX) {
              height *= MAX / width; width = MAX;
            } else if (height > MAX) {
              width *= MAX / height; height = MAX;
            }
            canvas.width = width; canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            canvas.toBlob(blob => resolve(blob), "image/jpeg", 0.85);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });

      const handleUpload = async () => {
        if (!file) return alert("Please select an image");
        if (!folderName || !sharepointDate) return alert("Please fill all fields");

        setUploading(true);
        setUploadProgress(0);

        try {
          const compressedBlob = await compressImage(file);
          const storageRef = storage.ref().child(`uploads/${Date.now()}-${file.name}`);
          const uploadTask = storageRef.put(compressedBlob);

          uploadTask.on(
            "state_changed",
            (snap) => {
              const progress = (snap.bytesTransferred / snap.totalBytes) * 100;
              setUploadProgress(progress);
            },
            (err) => console.error(err),
            async () => {
              const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
              await db.collection("images").add({
                filename: file.name,
                location: folderName,
                sharepointDate,
                imageUrl: downloadURL,
                approvalStatus: null,
                productName: "",
                supplier: "",
                reasonForInstall: "",
                additionalNotes: "",
                completed: false,
                addedDate: new Date().toISOString()
              });
              setFile(null);
              setFolderName("");
              setSharepointDate("");
              setUploading(false);
              setUploadProgress(0);
              alert("Upload complete!");
            }
          );
        } catch (err) {
          console.error("Upload error:", err);
          setUploading(false);
        }
      };

      const updateField = async (id, field, value) => {
        await db.collection("images").doc(id).update({ [field]: value });
      };

      const handleApproval = async (id, approved) => {
        await db.collection("images").doc(id).update({ approvalStatus: approved });
      };

      const markCompleted = async (id) => {
        await db.collection("images").doc(id).update({ completed: true });
      };

      const deleteImage = async (id) => {
        if (confirm("Delete this entry?")) {
          await db.collection("images").doc(id).delete();
        }
      };

      return (
        <div className="min-h-screen bg-gray-50 p-4 md:p-8">
          <div className="max-w-6xl mx-auto space-y-8">
            <div className="bg-white p-6 rounded-lg shadow">
              <h1 className="text-2xl font-bold mb-4">Upload Image</h1>
              <div className="grid md:grid-cols-3 gap-4 mb-4">
                <input
                  type="file"
                  accept="image/*"
                  onChange={(e) => setFile(e.target.files[0])}
                  className="border p-2 rounded"
                />
                <input
                  type="text"
                  placeholder="Folder name"
                  value={folderName}
                  onChange={(e) => setFolderName(e.target.value)}
                  className="border p-2 rounded"
                />
                <input
                  type="date"
                  value={sharepointDate}
                  onChange={(e) => setSharepointDate(e.target.value)}
                  className="border p-2 rounded"
                />
              </div>
              <button
                onClick={handleUpload}
                disabled={uploading}
                className={`px-4 py-2 rounded text-white ${uploading ? "bg-gray-400" : "bg-blue-600 hover:bg-blue-700"}`}
              >
                {uploading ? "Uploading..." : "Upload"}
              </button>

              {uploading && (
                <div className="mt-3 w-full bg-gray-200 rounded-full h-3">
                  <div
                    className="bg-blue-600 h-3 rounded-full transition-all duration-300"
                    style={{ width: `${uploadProgress}%` }}
                  ></div>
                </div>
              )}
            </div>

            {/* Display images */}
            {images.map((img) => (
              <div key={img.id} className="bg-white p-6 rounded-lg shadow">
                <div className="flex justify-between mb-3">
                  <div>
                    <h2 className="font-semibold">{img.filename}</h2>
                    <p className="text-sm text-gray-500">
                      Folder: {img.location || "N/A"} | Uploaded: {img.sharepointDate || "N/A"}
                    </p>
                  </div>
                  <button onClick={() => deleteImage(img.id)} className="text-red-600 hover:underline">
                    Delete
                  </button>
                </div>

                {img.imageUrl && <img src={img.imageUrl} className="rounded-lg mb-4" alt="" />}

                {img.approvalStatus === null && (
                  <div className="mb-4">
                    <p className="font-medium mb-2">Are you happy to post this on social media?</p>
                    <button onClick={() => handleApproval(img.id, true)} className="px-3 py-2 bg-green-600 text-white rounded mr-2">Yes</button>
                    <button onClick={() => handleApproval(img.id, false)} className="px-3 py-2 bg-red-600 text-white rounded">No</button>
                  </div>
                )}

                {img.approvalStatus === false && (
                  <div className="bg-red-50 p-3 rounded text-red-700 font-medium">Rejected</div>
                )}

                {img.approvalStatus === true && !img.completed && (
                  <>
                    <div className="grid gap-3 mb-3">
                      <input placeholder="Product name" value={img.productName} onChange={(e) => updateField(img.id, "productName", e.target.value)} className="border p-2 rounded" />
                      <input placeholder="Supplier / Manufacturer" value={img.supplier} onChange={(e) => updateField(img.id, "supplier", e.target.value)} className="border p-2 rounded" />
                      <textarea placeholder="Reason for install" value={img.reasonForInstall} onChange={(e) => updateField(img.id, "reasonForInstall", e.target.value)} className="border p-2 rounded" />
                      <textarea placeholder="Additional details" value={img.additionalNotes} onChange={(e) => updateField(img.id, "additionalNotes", e.target.value)} className="border p-2 rounded" />
                    </div>
                    <button onClick={() => markCompleted(img.id)} className="px-4 py-2 bg-green-600 text-white rounded">Mark Complete</button>
                  </>
                )}

                {img.completed && (
                  <div className="bg-green-50 p-3 rounded mt-3">
                    <p className="text-green-700 font-medium">âœ“ Completed</p>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<ShadeTracker />);
  </script>
</body>
</html>
