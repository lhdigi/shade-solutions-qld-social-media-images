<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shade Solutions QLD - Social Media Tracker</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCjT-UjngKoElF2RH1BayCup7CzjIrABBc",
      authDomain: "shade-solutions-tracker.firebaseapp.com",
      projectId: "shade-solutions-tracker",
      storageBucket: "shade-solutions-tracker.firebasestorage.app",
      messagingSenderId: "347513530369",
      appId: "1:347513530369:web:93abc25b52819139f2b800"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const db = getFirestore(app);

    let draggedFile = null;

    async function uploadImage() {
      const folderName = document.getElementById("folderName").value.trim();
      const sharepointDate = document.getElementById("sharepointDate").value;

      const file = draggedFile || document.getElementById("imageInput").files[0];
      if (!file) return alert("Please choose an image.");

      if (!folderName || !sharepointDate) return alert("Please enter folder and date.");

      const storageRef = ref(storage, 'images/' + Date.now() + "-" + file.name);
      const uploadTask = uploadBytesResumable(storageRef, file);

      const progressBar = document.getElementById("progressBar");
      progressBar.style.width = "0%";
      progressBar.parentElement.style.display = "block";

      uploadTask.on('state_changed',
        snapshot => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          progressBar.style.width = progress + "%";
        },
        error => console.error(error),
        async () => {
          const imageUrl = await getDownloadURL(uploadTask.snapshot.ref);
          await addDoc(collection(db, "images"), {
            name: file.name,
            url: imageUrl,
            folderName,
            sharepointDate,
            status: "pending",
            productName: "",
            supplier: "",
            reasonForInstall: "",
            additionalNotes: ""
          });

          document.getElementById("imageInput").value = "";
          document.getElementById("folderName").value = "";
          document.getElementById("sharepointDate").value = "";
          draggedFile = null;
          progressBar.parentElement.style.display = "none";
          loadImages();
        }
      );
    }

    async function loadImages() {
      const container = document.getElementById("imageContainer");
      container.innerHTML = "";

      const querySnapshot = await getDocs(collection(db, "images"));
      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const card = document.createElement("div");
        card.className = "card";

        let statusColor = data.status === "approved" ? "green" :
                          data.status === "rejected" ? "red" : "grey";

        card.innerHTML = `
          <img src="${data.url}" alt="${data.name}">
          <p><strong>File:</strong> ${data.name}</p>
          <p><strong>Folder:</strong> ${data.folderName || "-"}</p>
          <p><strong>Date on SharePoint:</strong> ${data.sharepointDate || "-"}</p>
          <div id="info-${docSnap.id}" class="info-fields" style="margin-top:10px;"></div>
          <div class="buttons" id="buttons-${docSnap.id}">
            ${
              data.status === "pending"
                ? `<button onclick="updateStatus('${docSnap.id}','approved')">Yes, post this</button>
                   <button onclick="updateStatus('${docSnap.id}','rejected')">No, donâ€™t post</button>`
                : `<p class="status" style="color:${statusColor}; font-weight:bold; margin-top:5px;">
                    ${data.status === "approved" ? "Approved" : "Rejected"}
                  </p>`
            }
          </div>
        `;
        container.appendChild(card);

        if(data.status === "approved") {
          const infoDiv = document.getElementById(`info-${docSnap.id}`);
          infoDiv.innerHTML = `
            <input type="text" placeholder="Product Name" value="${data.productName}" oninput="updateField('${docSnap.id}','productName',this.value)" class="info-input">
            <input type="text" placeholder="Supplier/Manufacturer" value="${data.supplier}" oninput="updateField('${docSnap.id}','supplier',this.value)" class="info-input">
            <textarea placeholder="Reason for Install" oninput="updateField('${docSnap.id}','reasonForInstall',this.value)" class="info-input">${data.reasonForInstall}</textarea>
            <textarea placeholder="Additional Notes" oninput="updateField('${docSnap.id}','additionalNotes',this.value)" class="info-input">${data.additionalNotes}</textarea>
          `;
        }
      });
    }

    window.updateStatus = async function(id, newStatus) {
      await updateDoc(doc(db,"images",id), {status:newStatus});
      loadImages();
    }

    window.updateField = async function(id, field, value) {
      await updateDoc(doc(db,"images",id), {[field]:value});
    }

    window.uploadImage = uploadImage;
    window.onload = loadImages;

    function allowDrop(ev) {
      ev.preventDefault();
    }

    function dropFile(ev) {
      ev.preventDefault();
      draggedFile = ev.dataTransfer.files[0];
      document.getElementById("imageInput").files = ev.dataTransfer.files;
    }

  </script>

  <style>
    body {font-family: Arial, sans-serif; background:#f9f9f9; margin:0; padding:20px;}
    h1 {text-align:center; margin-bottom:20px;}
    .upload-box {text-align:center; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:30px;}
    input, button, textarea {margin:5px; padding:8px; font-size:14px;}
    input, textarea {width:80%; display:block; margin:5px auto;}
    button {cursor:pointer; background:#007bff; color:white; border:none; border-radius:5px;}
    button:hover {background:#0056b3;}
    .card {background:white; border-radius:10px; padding:15px; margin:10px auto; max-width:400px; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-align:center;}
    img {max-width:100%; border-radius:8px; margin-bottom:10px;}
    .buttons button {margin:5px; padding:8px 12px;}
    .status {font-weight:bold; margin-top:10px;}
    .info-input {margin:5px 0; padding:6px; width:95%; display:block;}
    #progressContainer {display:none; width:80%; height:10px; background:#ddd; margin:10px auto; border-radius:5px;}
    #progressBar {height:10px; width:0%; background:#007bff; border-radius:5px;}
  </style>
</head>
<body>
  <h1>Shade Solutions QLD - Social Media Tracker</h1>

  <div class="upload-box" ondragover="allowDrop(event)" ondrop="dropFile(event)">
    <p>Drag & drop an image here, or click to select</p>
    <input type="file" id="imageInput" accept="image/*">
    <input type="text" id="folderName" placeholder="SharePoint Folder Name">
    <input type="date" id="sharepointDate">
    <button onclick="uploadImage()">Upload</button>
    <div id="progressContainer">
      <div id="progressBar"></div>
    </div>
  </div>

  <div id="imageContainer"></div>
</body>
</html>
