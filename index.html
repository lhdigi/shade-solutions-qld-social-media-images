<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Shade Solutions QLD - Image Tracker</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
<div id="root"></div>

<!-- React + Babel -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-storage-compat.js"></script>

<script type="text/babel">
const { useState, useEffect } = React;

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCjT-UjngKoElF2RH1BayCup7CzjIrABBc",
  authDomain: "shade-solutions-tracker.firebaseapp.com",
  projectId: "shade-solutions-tracker",
  storageBucket: "shade-solutions-tracker.firebasestorage.app",
  messagingSenderId: "347513530369",
  appId: "1:347513530369:web:93abc25b52819139f2b800"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

// Icons (same as your current design)
const CheckCircle = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
const AlertCircle = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;
const Trash2 = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
const Upload = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>;
const ThumbsUp = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>;
const ThumbsDown = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"></path></svg>;

function ShadeTracker() {
  const [images, setImages] = useState([]);
  const [uploading, setUploading] = useState(false);
  const [progress, setProgress] = useState({}); // track upload progress per file
  const [newFiles, setNewFiles] = useState([]);

  // Load from Firestore on mount
  useEffect(() => {
    const unsubscribe = db.collection("images").orderBy("addedDate", "desc")
      .onSnapshot(snapshot => {
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setImages(data);
      });
    return () => unsubscribe();
  }, []);

  const compressImage = (file) => {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const MAX = 1920;
          let { width, height } = img;
          if(width > height && width > MAX) { height *= MAX/width; width = MAX; }
          else if(height > width && height > MAX) { width *= MAX/height; height = MAX; }
          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img,0,0,width,height);
          canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.85);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });
  };

  const handleSelectFiles = (e) => {
    setNewFiles(Array.from(e.target.files));
  };

  const uploadNewFiles = async () => {
    if(newFiles.length === 0) return;
    setUploading(true);
    const progressCopy = {...progress};

    for(let i=0;i<newFiles.length;i++){
      const file = newFiles[i];
      const compressedBlob = await compressImage(file);
      const storageRef = storage.ref(`uploads/${Date.now()}-${file.name}`);
      const uploadTask = storageRef.put(compressedBlob);

      await new Promise((resolve, reject) => {
        uploadTask.on('state_changed', snapshot => {
          const percent = Math.round(snapshot.bytesTransferred / snapshot.totalBytes * 100);
          progressCopy[file.name] = percent;
          setProgress({...progressCopy});
        }, reject, async () => {
          const url = await uploadTask.snapshot.ref.getDownloadURL();
          const folderName = prompt(`Folder name for ${file.name}:`) || '';
          const sharepointDate = prompt(`SharePoint date for ${file.name} (YYYY-MM-DD):`) || '';

          await db.collection("images").add({
            filename: file.name,
            location: folderName,
            sharepointDate: sharepointDate,
            imageUrl: url,
            productName: '',
            supplier: '',
            reasonForInstall: '',
            additionalNotes: '',
            approvalStatus: null,
            completed: false,
            addedDate: new Date().toISOString()
          });
          resolve();
        });
      });
    }

    setNewFiles([]);
    setProgress({});
    setUploading(false);
  };

  const handleApproval = async (id, approved) => {
    await db.collection("images").doc(id).update({
      approvalStatus: approved,
      completed: !approved
    });
  };

  const markAsCompleted = async (id) => {
    await db.collection("images").doc(id).update({ completed: true });
  };

  const deleteImage = async (id) => {
    if(!confirm("Delete this entry?")) return;
    await db.collection("images").doc(id).delete();
  };

  const updateImage = async (id, field, value) => {
    await db.collection("images").doc(id).update({ [field]: value });
  };

  const sortedImages = [...images].sort((a,b) => (a.completed === b.completed ? 0 : a.completed ? 1 : -1));

  return (
    <div className="min-h-screen bg-gray-50 p-4 md:p-8">
      <div className="max-w-7xl mx-auto">
        <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
          <h1 className="text-3xl font-bold text-gray-900 mb-4">Shade Solutions QLD - Image Tracker</h1>
          <div className="flex gap-2 items-center">
            <label className="flex-1 cursor-pointer bg-gray-100 hover:bg-gray-200 px-4 py-3 rounded-lg text-center">
              Select Images
              <input type="file" multiple onChange={handleSelectFiles} className="hidden"/>
            </label>
            <button onClick={uploadNewFiles} disabled={uploading || newFiles.length===0} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Upload</button>
          </div>
          {newFiles.map(f=>(
            <div key={f.name} className="mt-2 text-sm text-gray-600">{f.name} {progress[f.name] && `- ${progress[f.name]}%`}</div>
          ))}
        </div>

        <div className="space-y-4">
          {sortedImages.map(img => (
            <div key={img.id} className={`bg-white rounded-lg shadow-sm p-6 border-l-4 ${img.completed ? 'border-green-500':'border-yellow-500'}`}>
              <div className="flex justify-between items-start mb-3">
                <div className="flex-1">
                  <h3 className="text-lg font-semibold">{img.filename}</h3>
                  {img.location && <p className="text-sm text-gray-600">Folder: {img.location}</p>}
                  {img.sharepointDate && <p className="text-sm text-gray-600">SharePoint: {img.sharepointDate}</p>}
                </div>
                <button onClick={()=>deleteImage(img.id)} className="text-red-500 hover:text-red-700"><Trash2/></button>
              </div>
              {img.imageUrl && <img src={img.imageUrl} alt={img.filename} className="w-full h-auto rounded-lg mb-3"/>}

              {img.approvalStatus===null && !img.completed && (
                <div className="flex gap-2">
                  <button onClick={()=>handleApproval(img.id,true)} className="bg-green-600 text-white px-3 py-1 rounded-lg flex items-center gap-1"><ThumbsUp/>Yes</button>
                  <button onClick={()=>handleApproval(img.id,false)} className="bg-red-600 text-white px-3 py-1 rounded-lg flex items-center gap-1"><ThumbsDown/>No</button>
                </div>
              )}

              {img.approvalStatus===true && !img.completed && (
                <button onClick={()=>markAsCompleted(img.id)} className="mt-2 bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2"><CheckCircle/>Mark Complete</button>
              )}

              {img.completed && <div className="mt-2 bg-green-50 p-3 rounded-lg text-green-900 font-medium">Completed</div>}
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<ShadeTracker />);
</script>
</body>
</html>
