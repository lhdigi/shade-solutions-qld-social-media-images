<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shade Solutions QLD - Image for Socials</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
<div id="root"></div>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-storage-compat.js"></script>

<script type="text/babel">
const { useState, useEffect } = React;

// --- Firebase setup ---
const firebaseConfig = {
  apiKey: "AIzaSyCjT-UjngKoElF2RH1BayCup7CzjIrABBc",
  authDomain: "shade-solutions-tracker.firebaseapp.com",
  projectId: "shade-solutions-tracker",
  storageBucket: "shade-solutions-tracker.firebasestorage.app",
  messagingSenderId: "347513530369",
  appId: "1:347513530369:web:93abc25b52819139f2b800"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

// --- Components ---
function ShadeTracker() {
  const [images, setImages] = useState([]);
  const [uploading, setUploading] = useState(false);
  const [uploadCount, setUploadCount] = useState(0);

  // Upload form fields
  const [folder, setFolder] = useState('');
  const [sharepointDate, setSharepointDate] = useState('');

  // Load images from Firestore
  useEffect(() => {
    const unsubscribe = db.collection("images").orderBy("addedDate","desc")
      .onSnapshot(snapshot => {
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setImages(data);
      });
    return () => unsubscribe();
  }, []);

  // Compress image
  const compressImage = (file) => new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        let { width, height } = img;
        const MAX_SIZE = 1920;
        if(width > height && width > MAX_SIZE) { height *= MAX_SIZE/width; width = MAX_SIZE; }
        if(height > width && height > MAX_SIZE) { width *= MAX_SIZE/height; height = MAX_SIZE; }
        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(img,0,0,width,height);
        canvas.toBlob(blob => resolve(blob),"image/jpeg",0.85);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });

  const handleBulkUpload = async (e) => {
    const files = Array.from(e.target.files);
    if(!files.length) return;
    if(!folder || !sharepointDate) {
      alert("Please provide SharePoint Folder Location and SharePoint Date Uploaded before uploading.");
      return;
    }

    setUploading(true);
    setUploadCount(0);

    for(let i=0;i<files.length;i++){
      const file = files[i];
      const formattedDate = sharepointDate;
      try {
        const blob = await compressImage(file);
        const storageRef = storage.ref().child(`uploads/${Date.now()}-${file.name}`);
        const snapshot = await storageRef.put(blob);
        const url = await snapshot.ref.getDownloadURL();

        await db.collection("images").add({
          filename: file.name,
          location: folder,
          sharepointDate: formattedDate,
          imageUrl: url,
          productName: "",
          supplier: "",
          reasonForInstall: "",
          additionalNotes: "",
          approvalStatus: null,
          completed: false,
          addedDate: new Date().toISOString()
        });

        setUploadCount(i+1);
      } catch(err){console.error(err);}
    }

    setUploading(false);
    setUploadCount(0);
    e.target.value="";
    setFolder('');
    setSharepointDate('');
  };

  const updateField = async (id, field, value) => {
    await db.collection("images").doc(id).update({ [field]: value });
  };

  const handleApproval = async (id, approved) => {
    await db.collection("images").doc(id).update({ approvalStatus: approved, completed: !approved });
  };

  const markCompleted = async (id) => {
    await db.collection("images").doc(id).update({ completed: true });
  };

  const deleteImage = async (id) => {
    if(!confirm("Delete this image?")) return;
    await db.collection("images").doc(id).delete();
  };

  const stats = {
    total: images.length,
    completed: images.filter(i=>i.completed).length,
    pending: images.filter(i=>!i.completed).length
  };

  // --- Sorting: newest first, completed go to bottom ---
  const sortedImages = [...images].sort((a,b) => {
    if(a.completed && !b.completed) return 1;
    if(!a.completed && b.completed) return -1;
    return new Date(b.addedDate) - new Date(a.addedDate);
  });

  return (
    <div className="min-h-screen p-6 md:p-12 bg-gray-50 max-w-7xl mx-auto">
      <h1 className="text-3xl font-bold text-center mb-6">Shade Solutions QLD - Image Tracker</h1>

      {/* Stats */}
      <div className="grid grid-cols-3 gap-4 mb-6">
        <div className="bg-blue-50 rounded-lg p-4 text-center">
          <div className="text-2xl font-bold text-blue-900">{stats.total}</div>
          <div className="text-sm text-blue-700">Total Images</div>
        </div>
        <div className="bg-green-50 rounded-lg p-4 text-center">
          <div className="text-2xl font-bold text-green-900">{stats.completed}</div>
          <div className="text-sm text-green-700">Completed</div>
        </div>
        <div className="bg-yellow-50 rounded-lg p-4 text-center">
          <div className="text-2xl font-bold text-yellow-900">{stats.pending}</div>
          <div className="text-sm text-yellow-700">Pending</div>
        </div>
      </div>

      {/* Upload */}
      <div className="bg-white rounded-lg shadow p-6 mb-6">
        <h2 className="text-xl font-semibold mb-4">For Luke to Upload Images</h2>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label className="block text-gray-700 font-medium mb-1">SharePoint Folder Location</label>
            <input type="text" value={folder} onChange={(e)=>setFolder(e.target.value)} className="border px-3 py-2 rounded w-full"/>
          </div>
          <div>
            <label className="block text-gray-700 font-medium mb-1">SharePoint Date</label>
            <input type="date" value={sharepointDate} onChange={(e)=>setSharepointDate(e.target.value)} className="border px-3 py-2 rounded w-full"/>
          </div>
        </div>

        <label className="flex flex-col items-center justify-center h-48 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
          <p className="text-gray-500 text-center mt-6">Click to select or drag & drop images</p>
          <input type="file" multiple accept="image/*" onChange={handleBulkUpload} className="hidden" disabled={uploading}/>
        </label>

        {uploading && (
          <div className="mt-4">
            <p className="text-gray-600 mb-1">Processing... {uploadCount}</p>
            <div className="w-full h-2 bg-gray-200 rounded-full">
              <div className="bg-blue-600 h-2 rounded-full animate-pulse"></div>
            </div>
          </div>
        )}
      </div>

      {/* Images */}
      <div className="space-y-4">
        {sortedImages.length===0 ? (
          <div className="bg-white rounded-lg shadow p-12 text-center text-gray-500">No images yet. Upload to start.</div>
        ) : sortedImages.map(img=>(
          <div key={img.id} className={`bg-white rounded-lg shadow p-6 border-l-4 ${img.completed?'border-green-500':'border-yellow-500'}`}>
            <div className="flex justify-between items-start mb-4">
              <h3 className="text-lg font-semibold">{img.filename}</h3>
              <button onClick={()=>deleteImage(img.id)} className="text-red-500 hover:text-red-700">Delete</button>
            </div>

            {img.imageUrl && <img src={img.imageUrl} alt={img.filename} className="w-full h-auto rounded-lg mb-4 object-contain"/>}

            {/* Folder & SharePoint Date Uploaded display */}
            <div className="grid grid-cols-2 gap-4 mb-4">
              <div>
                <label className="block text-gray-700 font-medium mb-1">SharePoint Folder Location</label>
                <input type="text" value={img.location} readOnly className="border px-3 py-2 rounded w-full bg-gray-100"/>
              </div>
              <div>
                <label className="block text-gray-700 font-medium mb-1">SharePoint Date</label>
                <input type="date" value={img.sharepointDate} readOnly className="border px-3 py-2 rounded w-full bg-gray-100"/>
              </div>
            </div>

            {/* Approval */}
            {img.approvalStatus===null && !img.completed && (
              <div className="flex gap-3 mb-4">
                <button onClick={()=>handleApproval(img.id,true)} className="flex-1 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Yes, post on socials</button>
                <button onClick={()=>handleApproval(img.id,false)} className="flex-1 px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">No, do not post</button>
              </div>
            )}

            {/* Info fields */}
            {img.approvalStatus===true && !img.completed && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <input placeholder="Product Name / Description" value={img.productName} onChange={(e)=>updateField(img.id,'productName',e.target.value)} className="border px-3 py-2 rounded w-full"/>
                <input placeholder="Supplier / Manufacturer" value={img.supplier} onChange={(e)=>updateField(img.id,'supplier',e.target.value)} className="border px-3 py-2 rounded w-full"/>
                <textarea placeholder="Reason for Install" value={img.reasonForInstall} onChange={(e)=>updateField(img.id,'reasonForInstall',e.target.value)} className="border px-3 py-2 rounded md:col-span-2"/>
                <textarea placeholder="Additional Notes" value={img.additionalNotes} onChange={(e)=>updateField(img.id,'additionalNotes',e.target.value)} className="border px-3 py-2 rounded md:col-span-2"/>
                <button onClick={()=>markCompleted(img.id)} className="px-6 py-2 bg-green-600 text-white rounded-lg col-span-full">All Information Added - Mark Complete</button>
              </div>
            )}

            {/* Completed / Rejected */}
            {img.completed && (
              <div className={`p-4 rounded ${img.approvalStatus===false?'bg-red-100':'bg-green-50'}`}>
                {img.approvalStatus===false ? (
                  <p className="text-red-700 font-semibold">❌ Not for Social Media</p>
                ) : (
                  <div className="text-green-900 space-y-1">
                    <p className="font-semibold">✓ Completed</p>
                    {img.productName && <p><strong>Product:</strong> {img.productName}</p>}
                    {img.supplier && <p><strong>Supplier:</strong> {img.supplier}</p>}
                    {img.reasonForInstall && <p><strong>Reason:</strong> {img.reasonForInstall}</p>}
                    {img.additionalNotes && <p><strong>Notes:</strong> {img.additionalNotes}</p>}
                  </div>
                )}
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<ShadeTracker />);
</script>
</body>
</html>
